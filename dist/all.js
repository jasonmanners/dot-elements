function SfxrParams(){this.setSettings=function(t){for(var e=0;24>e;e++)this[String.fromCharCode(97+e)]=t[e]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;if(.18>i){var s=.18/i;this.b*=s,this.c*=s,this.e*=s}}}function SfxrSynth(){this._params=new SfxrParams;var t,e,i,s,r,n,o,a,h,l,c,d;this.reset=function(){var t=this._params;s=100/(t.f*t.f+.001),r=100/(t.g*t.g+.001),n=1-t.h*t.h*t.h*.01,o=-t.i*t.i*t.i*1e-6,t.a||(c=.5-t.n/2,d=5e-5*-t.o),a=1+t.l*t.l*(t.l>0?-.9:10),h=0,l=1==t.m?0:(1-t.m)*(1-t.m)*2e4+32},this.totalReset=function(){this.reset();var s=this._params;return t=s.b*s.b*1e5,e=s.c*s.c*1e5,i=s.e*s.e*1e5+12,3*((t+e+i)/3|0)},this.synthWave=function(u,m){var f=this._params,p=1!=f.s||f.v,g=f.v*f.v*.1,y=1+3e-4*f.w,v=f.s*f.s*f.s*.1,x=1+1e-4*f.t,$=1!=f.s,w=f.x*f.x,E=f.g,S=f.q||f.r,I=f.r*f.r*f.r*.2,b=f.q*f.q*(f.q<0?-1020:1020),M=f.p?((1-f.p)*(1-f.p)*2e4|0)+32:0,T=f.d,C=f.j/2,k=f.k*f.k*.01,P=f.a,A=t,L=1/t,R=1/e,_=1/i,Z=5/(1+f.u*f.u*20)*(.01+v);Z>.8&&(Z=.8),Z=1-Z;for(var D,B,H,O,W,N,F=!1,G=0,j=0,K=0,U=0,q=0,z=0,Y=0,V=0,J=0,X=0,Q=new Array(1024),te=new Array(32),ee=Q.length;ee--;)Q[ee]=0;for(var ee=te.length;ee--;)te[ee]=2*Math.random()-1;for(var ee=0;m>ee;ee++){if(F)return ee;if(M&&++J>=M&&(J=0,this.reset()),l&&++h>=l&&(l=0,s*=a),n+=o,s*=n,s>r&&(s=r,E>0&&(F=!0)),B=s,C>0&&(X+=k,B*=1+Math.sin(X)*C),B|=0,8>B&&(B=8),P||(c+=d,0>c?c=0:c>.5&&(c=.5)),++j>A)switch(j=0,++G){case 1:A=e;break;case 2:A=i}switch(G){case 0:K=j*L;break;case 1:K=1+2*(1-j*R)*T;break;case 2:K=1-j*_;break;case 3:K=0,F=!0}S&&(b+=I,H=0|b,0>H?H=-H:H>1023&&(H=1023)),p&&y&&(g*=y,1e-5>g?g=1e-5:g>.1&&(g=.1)),N=0;for(var ie=8;ie--;){if(Y++,Y>=B&&(Y%=B,3==P))for(var se=te.length;se--;)te[se]=2*Math.random()-1;switch(P){case 0:W=c>Y/B?.5:-.5;break;case 1:W=1-Y/B*2;break;case 2:O=Y/B,O=6.28318531*(O>.5?O-1:O),W=1.27323954*O+.405284735*O*O*(0>O?1:-1),W=.225*((0>W?-1:1)*W*W-W)+W;break;case 3:W=te[Math.abs(32*Y/B|0)]}p&&(D=z,v*=x,0>v?v=0:v>.1&&(v=.1),$?(q+=(W-z)*v,q*=Z):(z=W,q=0),z+=q,U+=z-D,U*=1-g,W=U),S&&(Q[V%1024]=W,W+=Q[(V-H+1024)%1024],V++),N+=W}N*=.125*K*w,u[ee]=N>=1?32767:-1>=N?-32768:32767*N|0}return m}}$.Animation=function(){this.life=0,this.alive=0,this.skeleton={}},$.Animation.prototype={update:function(t){this.alive+=t}},$.Camera=function(){this.offset={x:0,y:-100},this.viewWidth=0,this.viewHeight=450,this.gutter={x:0,y:0}},$.Camera.prototype={moveLeft:function(){this.move("x",-1)},moveRight:function(){this.move("x",1)},move:function(t,e){this.offset[t]+=e},update:function(t){t.x>this.absoluteRight()?(this.offset.x+=t.x-this.absoluteRight(),this.offset.x=Math.min(this.offset.x,$.const.SIZE.x-this.viewWidth-$.const.TILE_SIZE)):t.x<this.absoluteLeft()&&(this.offset.x-=this.absoluteLeft()-t.x,this.offset.x=Math.max(this.offset.x,0)),t.y>this.absoluteBottom()?this.offset.y+=t.y-this.absoluteBottom():t.y<this.absoluteTop()&&(this.offset.y-=this.absoluteTop()-t.y)},absoluteRight:function(){return this.viewWidth-this.gutter.x+this.offset.x},absoluteLeft:function(){return this.offset.x+this.gutter.x},absoluteTop:function(){return this.offset.y+this.gutter.y},absoluteBottom:function(){return this.viewHeight-this.gutter.y+this.offset.y}},$.Definitions={},$.Enemy=function(t){this.pos=t||{x:0,y:0},this.vel={x:0,y:0,max:150,delta:{x:0,y:0}},this.acc={x:150,y:0},this.delta={x:0,y:0},this.mass=5,this.prevPos=this.pos,this.dir=1,this.health=100,this.width=$.const.TILE_SIZE,this.height=$.const.TILE_SIZE,this.radius=$.const.TILE_SIZE/2,this.time=0,this.jumpCounter=0,this.jumpOnNextUpdate=!1,this.damage=5},$.Enemy.prototype={jump:function(){this.jumpCounter<1&&(this.vel.y=-500,this.jumpCounter++),this.jumpOnNextUpdate=!1},update:function(t,e){this.dir=this.pos.x-e.pos.x>0?-1:1;var i=t/1e3;this.vel.delta.x=this.dir*i*this.acc.x,Math.abs(this.vel.x+this.vel.delta.x)<=this.vel.max&&(this.vel.x+=this.vel.delta.x),this.vel.y+=i*this.acc.y+i*$.const.GRAVITY*this.mass,this.delta.x=this.vel.x*i,this.delta.y=this.vel.y*i,this.prevPos={x:this.pos.x,y:this.pos.y},this.pos.x+=this.delta.x,this.pos.y+=this.delta.y,this.time+=t},draw:function(t){var e={x:this.pos.x+7.5,y:this.pos.y+7.5};t.save(),$.render.fillCircle(t,e,this.radius,{r:0,g:0,b:0,a:1}),t.restore()}},$.Game=function(){document.getElementById("pause").innerHTML="",this.hero=null,this.running=!1,this.canvas=null,this.context=null,this.particles=null,this.width=800,this.height=450,this.time={last:0,delta:0,total:0},this.mouse={x:0,y:0},this.shrines={water:null,earth:null,fire:null,air:null},this.enemies=[],this.init()},$.Game.prototype={init:function(){this.initObjects(),this.initCanvas(),this.initKeybindings(),this.initMouse(),this.initParticleEmitter(),this.initShrines(),window.testImg=$.Tile.images.dirt[0]["1.0"];var t=$.Tile.images.dirt[0]["1.0"].toDataURL();document.getElementById("slot-1-preview").src=t;var e=document.createElement("canvas"),i=e.getContext("2d");e.width=$.utils.toWorldIndex($.const.SIZE.x),e.height=$.utils.toWorldIndex($.const.SIZE.y),e.style.margin="100px auto",e.style.display="block",e.className="map";for(var s=0;s<this.world.map.length;s++)for(var r=0;r<this.world.map[s].length;r++)i.fillStyle="#93C0DD",1===this.world.map[s][r]?i.fillStyle="#473020":2===this.world.map[s][r]?i.fillStyle="#93C0DD":(this.world.map[s][r]-1)%3===0?i.fillStyle="#871E1E":(this.world.map[s][r]-1)%3===1?i.fillStyle="#1B7F2F":(this.world.map[s][r]-1)%3===2&&(i.fillStyle="#436B87"),i.fillRect(s,r,1,1);document.getElementById("pause").appendChild(e)},initObjects:function(){$.Tile.init(),this.hero=new $.Hero,this.world=new $.World,this.camera=new $.Camera,this.camera.offset.x=1e3,this.hero.pos.x=1500,this.hero.pos.y=100,this.hero.startPos.x=1500,this.hero.startPos.y=100,this.camera.viewWidth=800,this.camera.gutter.x=300,this.camera.gutter.y=150},initCanvas:function(){this.canvas=document.getElementById("world"),this.context=this.canvas.getContext("2d")},initParticleEmitter:function(){this.particles=$.ParticleEmitter},initShrines:function(){for(var t=$.utils.getRandom(this.world.tiles),e=0;e<t.length;e++)if(t[e]&&t[e].solid){var i=75;this.shrines.water=new $.Shrine({x:t[e].pos.x,y:t[e].pos.y-i},{r:74,g:176,b:244,a:.95},{r:16,g:49,b:142,a:.95}),this.shrines.water.radius=i;break}for(var t=$.utils.getRandom(this.world.tiles),e=0;e<t.length;e++)if(t[e]&&t[e].solid){var i=75;this.shrines.fire=new $.Shrine({x:t[e].pos.x,y:t[e].pos.y-i},{r:247,g:42,b:42,a:.8},{r:247,g:247,b:42,a:.8}),this.shrines.fire.radius=i;break}for(var t=$.utils.getRandom(this.world.tiles),e=0;e<t.length;e++)if(t[e]&&t[e].solid){var i=75;this.shrines.earth=new $.Shrine({x:t[e].pos.x,y:t[e].pos.y-i},{r:56,g:63,b:0,a:.8},{r:51,g:33,b:1,a:.8}),this.shrines.earth.radius=i;break}var s=Math.floor(Math.random()*this.world.tiles.length),r=-6,i=75;this.shrines.air=new $.Shrine({x:s*$.const.TILE_SIZE,y:r*$.const.TILE_SIZE},{r:230,g:240,b:255,a:.8},{r:200,g:200,b:210,a:.8}),this.shrines.air.radius=i},initMouse:function(){this.canvas.onmousemove=function(t){var e=this.canvas.getBoundingClientRect();this.mouse.x=t.clientX-e.left-5+this.camera.offset.x,this.mouse.y=t.clientY-e.top-5+this.camera.offset.y}.bind(this),this.canvas.onmousedown=function(){$.pressed.mouse=!0}.bind(this),this.canvas.onmouseup=function(){$.pressed.mouse=!1}.bind(this)},initKeybindings:function(){$.utils.bindKeyDown("a",this.hero.moveLeft.bind(this.hero)),$.utils.bindKeyDown("d",this.hero.moveRight.bind(this.hero)),$.utils.bindKeyDown("space",this.hero.jump.bind(this.hero)),$.utils.bindKeyDown("1",this.hero.setMode.bind(this.hero,1)),$.utils.bindKeyDown("2",this.hero.setMode.bind(this.hero,2)),$.utils.bindKeyDown("3",this.hero.setMode.bind(this.hero,4)),$.utils.bindKeyDown("esc",function(){this.hero.mode>0?this.hero.setMode(0):this.running?this.pause():this.run()}.bind(this)),$.utils.bindKeyDown("z",this.hero.power.bind(this.hero,this.world.tiles)),$.utils.bindKeyUp("a",this.hero.stop.bind(this.hero)),$.utils.bindKeyUp("d",this.hero.stop.bind(this.hero)),$.utils.bindKeyDown("`",this.hero.returnHome.bind(this.hero)),window.onkeydown=function(t){var e=$.const.KEYS[t.keyCode]||t.keyCode;return console.log("[KEY PRESSED] {%s : %s}",t.keyCode,e),$.pressed[e]=!0,$.keybindings.down[e]?($.keybindings.down[e](),!1):void 0},window.onkeyup=function(t){var e=$.const.KEYS[t.keyCode]||t.keyCode;$.pressed[e]=!1,$.keybindings.up[e]&&$.keybindings.up[e]()}},handleEvents:function(){for(var t in $.keybindings)$.pressed[t]&&$.keybindings[t]()},update:function(t){this.hero.update(t),this.world.update(t),this.particles.update(t),$.pressed.mouse&&this.hero.power(this.world.tiles,this.mouse);for(var e=0;e<this.enemies.length;e++){var i=this.enemies[e];i.jumpOnNextUpdate&&i.jump(),i.update(t,this.hero)}if(this.shrines.water&&this.shrines.water.update(t),this.shrines.fire&&this.shrines.fire.update(t),this.shrines.earth&&this.shrines.earth.update(t),this.shrines.air&&this.shrines.air.update(t),Math.sin(this.time.total/5e4)>0&&this.world.isNight()?this.world.setDay():Math.sin(this.time.total/5e4)<0&&this.world.isDay()&&this.world.setNight(),100*Math.random()>98&&this.enemies.length<7){var s=$.utils.getRandomIndex(this.world.tiles),r=this.world.findFloor(s);this.enemies.push(new $.Enemy({x:r.pos.x,y:r.pos.y-15}))}},collisions:function(){var t=this.hero.getCenter().x,e=this.hero.getCenter().y,i=this.world.tiles;this.hero.pos.x=Math.max(0,this.hero.pos.x),this.hero.pos.x=Math.min(this.hero.pos.x,$.const.SIZE.x-2*$.const.TILE_SIZE),this.hero.pos.y=Math.max(0,this.hero.pos.y),this.hero.pos.y=Math.min(this.hero.pos.y,$.const.SIZE.y);var s=6,r=8,n=Math.floor(t/$.const.TILE_SIZE)-3,o=Math.floor(e/$.const.TILE_SIZE)-4;n=Math.max(0,n),o=Math.max(0,o),n=Math.min(n,i.length-s);for(var a=n;n+s>a;a++)for(var h=o;o+r>h;h++)if(i[a][h]&&i[a][h].solid){var l=i[a][h];this.characterCollision(this.hero,l,a,h)}for(var c=0;c<this.enemies.length;c++){var d=this.enemies[c];$.utils.detectRadiusCollision(this.hero.pos,d.pos,10)&&this.hero.takeDamage(d.damage);var n=Math.floor(d.pos.x/$.const.TILE_SIZE)-3,o=Math.floor(d.pos.y/$.const.TILE_SIZE)-4;n=Math.max(0,n),o=Math.max(0,o),n=Math.min(n,i.length-s);for(var a=n;n+s>a;a++)for(var h=o;o+r>h;h++)if(i[a][h]&&i[a][h].solid){var l=i[a][h],u=this.characterCollision(d,l,a,h);(u.left||u.right)&&(d.jumpOnNextUpdate=!0)}}for(var a=$.ParticleEmitter.particles.length;a--;){var m=$.ParticleEmitter.particles[a];if(m.solid)for(var h=this.enemies.length;h--;){var d=this.enemies[h];if($.utils.detectRadiusCollision(m.pos,d.pos,30)){this.enemies.splice(h,1),$.ParticleEmitter.particles.splice(a,1);for(var f=0;10>f;f++)$.ParticleEmitter.add.explosion($.utils.deepCopy(d.pos),200*Math.random()+100,4*Math.PI/3-Math.PI*Math.random()*2/3);break}}}this.shrines.water&&$.utils.distance(this.shrines.water.pos,this.hero.pos)<this.shrines.water.radius+this.hero.height&&(this.hero.shrines++,this.shrines.water=null),this.shrines.earth&&$.utils.distance(this.shrines.earth.pos,this.hero.pos)<this.shrines.earth.radius+this.hero.height&&(this.hero.shrines++,this.shrines.earth=null),this.shrines.fire&&$.utils.distance(this.shrines.fire.pos,this.hero.pos)<this.shrines.fire.radius+this.hero.height&&(this.hero.shrines++,this.shrines.fire=null),this.shrines.air&&$.utils.distance(this.shrines.air.pos,this.hero.pos)<this.shrines.air.radius+this.hero.height&&(this.hero.shrines++,this.shrines.air=null)},characterCollision:function(t,e,i,s){var r={x:t.pos.x,y:t.pos.y,width:t.width,height:t.height,vel:{x:t.vel.x,y:t.vel.y}},n={x:e.pos.x,y:e.pos.y,width:$.const.TILE_SIZE,height:$.const.TILE_SIZE,vel:{x:0,y:0}},o=$.utils.detectCollision(r,n);if(o.top&&(t.pos.y=n.y+n.height,t.acc.y=0,t.vel.y=0),o.bottom){for(;s&&null!==this.world.tiles[i][s-1];)s--;t.pos.y=this.world.tiles[i][s].pos.y-t.height,t.acc.y=0,t.vel.y=0,t.jumpCounter=0}return o.left&&(t.pos.x=n.x+n.width),o.right&&(t.pos.x=n.x-t.width),o},draw:function(){this.context.clearRect(0,0,this.width,this.height),this.context.save(),this.world.drawBackground(this.context,this.width,this.height),this.context.translate(-this.camera.offset.x,-this.camera.offset.y),this.world.draw(this.context,this.camera);for(var t=0;t<this.enemies.length;t++)this.enemies[t].draw(this.context);if(this.particles.draw(this.context),this.hero.draw(this.context),this.shrines.water&&this.shrines.water.draw(this.context),this.shrines.earth&&this.shrines.earth.draw(this.context),this.shrines.fire&&this.shrines.fire.draw(this.context),this.shrines.air&&this.shrines.air.draw(this.context),0!==this.hero.mode&&this.hero.mode<4&&this.drawMouse(this.context),this.context.restore(),this.world.isNight()){var e=document.createElement("canvas"),i=e.getContext("2d");e.width=this.width,e.height=this.height,i.save(),i.fillStyle="rgba(0,0,0,0.9)",i.fillRect(0,0,this.width,this.height),i.restore(),i.save(),i.globalCompositeOperation="xor";var s=i.createRadialGradient(this.hero.pos.x-this.camera.offset.x,this.hero.pos.y-this.camera.offset.y,30,this.hero.pos.x-this.camera.offset.x,this.hero.pos.y-this.camera.offset.y,200);s.addColorStop(0,$.utils.colorString(255,200,0,.8)),s.addColorStop(1,$.utils.colorString(255,200,0,0)),$.render.fillCircle(i,{x:this.hero.pos.x-this.camera.offset.x,y:this.hero.pos.y-this.camera.offset.y},200,s),i.restore(),this.context.save(),this.context.drawImage(e,0,0,this.width,this.height),this.context.restore()}},drawMouse:function(t){var e=Math.floor(this.mouse.x/$.const.TILE_SIZE)*$.const.TILE_SIZE,i=Math.floor(this.mouse.y/$.const.TILE_SIZE)*$.const.TILE_SIZE;t.save(),t.save(),t.strokeStyle=$.utils.colorString(59,188,217,1),t.rect(e,i,$.const.TILE_SIZE,$.const.TILE_SIZE),t.stroke(),t.strokeStyle=$.utils.colorString(18,51,64,1),t.rect(e,i,$.const.TILE_SIZE,$.const.TILE_SIZE),t.stroke(),t.restore(),t.restore()},pause:function(){this.running=!1,document.getElementById("pause-pane").style.display="block",document.getElementById("pause").style.display="block"},run:function(){this.running=!0,document.getElementById("pause-pane").style.display="none",this.time.last=0,this.tick()},start:function(){document.getElementById("ui").style.display="block",document.getElementById("start").style.display="none",document.getElementById("died").style.display="none",this.run()},tick:function(t){var e=t||0;0===this.time.last&&(this.time.last=e),this.time.delta=e-this.time.last,this.time.delta>50&&(this.time.delta=50),this.time.total+=this.time.delta,this.update(this.time.delta),this.collisions(),this.camera.update(this.hero.pos),this.time.last=e,this.hero.win()?(this.pause(),document.getElementById("pause-pane").style.display="block",document.getElementById("win").style.display="block",document.getElementById("died").style.display="none",document.getElementById("pause").style.display="none"):this.hero.lose()&&(this.pause(),document.getElementById("pause-pane").style.display="block",document.getElementById("died").style.display="block",document.getElementById("pause").style.display="none"),this.draw(),this.running&&requestAnimationFrame(this.tick.bind(this))}},$.Hero=function(){this.pos={x:0,y:0},this.startPos={x:0,y:0},this.vel={x:0,y:0,max:300,delta:{x:0,y:0}},this.acc={x:0,y:0},this.delta={x:0,y:0},this.mass=5,this.prevPos=this.pos,this.dir=1,this.powers=[],this.health=10,this.jumpCounter=0,this.width=$.const.TILE_SIZE,this.height=$.const.TILE_SIZE,this.radius=$.const.TILE_SIZE/2,this.mineDistance=100,this.inventory={dirt:0},this.timings={mining:{current:0,threshold:250},shooting:{current:0,threshold:500},damage:{current:0,threshold:250},returnHome:{current:0,threshold:1e4}},this.time=0,this.height=22.5,this.frame={num:0,cur:0,step:250},this.mode=0,this.shrines=0,this.sprite=new $.Sprite;var t=new $.Piece({x:7.5,y:7.5});t.name="head",t.draw=function(t){$.render.fillCircle(t,this.center,7.5,{r:42,g:239,b:247,a:.8}),$.render.strokeCircle(t,this.center,7.5,3,{r:11,g:73,b:182,a:.5})};var e=new $.Piece({x:7.5,y:17.5});e.name="foot",e.draw=function(t){$.render.fillCircle(t,this.center,3.75,{r:42,g:239,b:247,a:.8}),$.render.strokeCircle(t,this.center,3.75,3,{r:11,g:73,b:182,a:.5})};var i=new $.Animation;i.skeleton.head=function(t,e,i){e.y=i.y-4-1*Math.sin(this.alive/250),e.x=i.x+s.vel.x/70}.bind(i);var s=this,r=new $.Animation;r.skeleton.head=function(t,e,i){e.x=i.x+s.vel.x/70,e.y=i.y-4-1*Math.sin(this.alive/250)}.bind(r);var n=new $.Animation;n.skeleton.head=function(t,e,i){e.x=i.x+s.vel.x/70,e.y=i.y-4-1*Math.sin(this.alive/250)}.bind(n),this.sprite.pieces.push(e),this.sprite.pieces.push(t),this.sprite.animations.idle=i,this.sprite.animations.left_run=r,this.sprite.animations.right_run=n,this.sprite.currentAnimation=this.sprite.animations.idle,this.emitter=new $.Emitter},$.Hero.prototype={win:function(){return 4===this.shrines},lose:function(){return this.health<0},takeDamage:function(t){this.canTakeAction("damage")&&(this.timings.damage.current=0,this.health-=t)},returnHome:function(){this.timings.returnHome.current>this.timings.returnHome.threshold&&(this.pos.x=this.startPos.x,this.pos.y=this.startPos.y,this.timings.returnHome.current=0)},canTakeAction:function(t){return this.timings[t].current>this.timings[t].threshold},getCenter:function(){return{x:this.pos.x+this.width/2,y:this.pos.y+this.height/2}},setMode:function(t){this.mode=t},power:function(t,e){var i=Math.floor(e.x/$.const.TILE_SIZE),s=Math.floor(e.y/$.const.TILE_SIZE);if(1&this.mode&&null!==t[i][s]&&this.withinRange(e)){if(this.timings.mining.current>this.timings.mining.threshold){t[i][s]=null,this.inventory.dirt++;for(var r=0;10>r;r++)$.ParticleEmitter.add.dirt($.utils.deepCopy(e),200*Math.random()+100,4*Math.PI/3-Math.PI*Math.random()*2/3);this.timings.mining.current=0}}else if(this.mode>>1&1&&this.inventory.dirt>0&&this.withinRange(e))null===t[i][s]&&(t[i][s]=new $.Tile.Dirt({x:i*$.const.TILE_SIZE,y:s*$.const.TILE_SIZE}),this.inventory.dirt--);else if(this.mode>>2&1&&this.timings.shooting.current>this.timings.shooting.threshold){var n=1;this.pos.x>e.x&&(n=-1);var o=e.x-this.pos.x,a=e.y-this.pos.y;n=Math.atan2(-a,o)+.5*Math.PI;var h=$.ParticleEmitter.add.fireball($.utils.deepCopy(this.pos),800,n);h.solid=!0,this.timings.shooting.current=0}document.getElementById("slot-1-qty").innerHTML=this.inventory.dirt},withinRange:function(t){return Math.abs($.utils.distance(t,this.pos))<this.mineDistance},moveLeft:function(){this.dir=-1,this.acc.x=650,this.sprite.currentAnimation=this.sprite.animations.left_run},moveRight:function(){this.dir=1,this.acc.x=650,this.sprite.currentAnimation=this.sprite.animations.right_run},stop:function(){this.acc.x=-1e3,this.sprite.currentAnimation=this.sprite.animations.idle},move:function(t,e){this.pos[t]+=e},jump:function(){this.jumpCounter<2&&(this.jumpCounter++,this.vel.y=-500)},update:function(t){var e=t/1e3;this.vel.delta.x=this.dir*e*this.acc.x,Math.abs(this.vel.x+this.vel.delta.x)<=this.vel.max&&(this.vel.x+=this.vel.delta.x),(this.vel.x<0&&1===this.dir||this.vel.x>0&&-1===this.dir)&&(this.vel.x=0),this.vel.y+=e*this.acc.y+e*$.const.GRAVITY*this.mass,this.delta.x=this.vel.x*e,this.delta.y=this.vel.y*e,this.prevPos={x:this.pos.x,y:this.pos.y},this.pos.x+=this.delta.x,this.pos.y+=this.delta.y,this.sprite.update(t),this.time+=t,this.updateTimings(t)},updateTimings:function(t){for(var e=Object.keys(this.timings),i=e.length;i--;){var s=this.timings[e[i]];s.current<=s.threshold&&(s.current+=t)}},draw:function(t){var e=this.pos.x,i=this.pos.y;t.save();var s={x:e+5+this.vel.x/70,y:i-this.height/3*1-10},r={x:e+5+this.vel.x/70,y:i-this.height/3*2-10},n=Math.sin(this.time/150),o=Math.cos(this.time/150),a=n*this.width/4+e+5+-1*this.vel.x*.05,h=5*o+i-this.height-10;t.beginPath(),t.moveTo(e+this.vel.x/70,this.getCenter().y-10),t.bezierCurveTo(s.x,s.y,r.x+o*(this.width/2),r.y,a,h),t.bezierCurveTo(r.x+o*(this.width/2),r.y,s.x,s.y+10*o,e+this.width+this.vel.x/70,this.getCenter().y-10),t.strokeStyle="#400900",t.stroke(),t.closePath(),t.fillStyle="rgba(255,3,0,0.6)",t.fill(),t.restore(),t.save(),t.translate(this.pos.x,this.pos.y),this.sprite.draw(t),t.restore()}};var start=document.getElementById("start-btn");start.onclick=function(){var t=new $.Game;window.game=t,t.start()};var respawn=document.getElementById("respawn-btn");respawn.onclick=function(){window.game=null;var t=new $.Game;window.game=t,t.start()};var respawn=document.getElementById("restart-btn");respawn.onclick=function(){window.game=null;var t=new $.Game;window.game=t,t.start()};var synth=new SfxrSynth;window.jsfxr=function(t){synth._params.setSettings(t);var e=synth.totalReset(),i=new Uint8Array(4*((e+1)/2|0)+44),s=2*synth.synthWave(new Uint16Array(i.buffer,44),e),r=new Uint32Array(i.buffer,0,44);r[0]=1179011410,r[1]=s+36,r[2]=1163280727,r[3]=544501094,r[4]=16,r[5]=65537,r[6]=44100,r[7]=88200,r[8]=1048578,r[9]=1635017060,r[10]=s,s+=44;for(var n=0,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a="data:audio/wav;base64,";s>n;n+=3){var h=i[n]<<16|i[n+1]<<8|i[n+2];a+=o[h>>18]+o[h>>12&63]+o[h>>6&63]+o[63&h]}return a},$.Particle=function(t,e){this.pos=t||{x:0,y:0},this.size={x:$.const.TILE_SIZE,y:$.const.TILE_SIZE},this.image=e,this.vel={x:0,y:0},this.dir=0,this.life=0,this.alive=0,this.solid=!1,this.mass=0,this.grow=0},$.Particle.prototype={update:function(t){var e=t/1e3;this.emitter&&this.alive>100&&this.emitter.update(t,this.pos);return this.vel.y+=e*$.const.GRAVITY*this.mass,this.pos.x+=e*this.vel.x,this.pos.y+=e*this.vel.y,this.alive+=t,this.alive+=t,this.alive>this.life?!0:!1},draw:function(t,e){e=e||this.image,t.save(),t.translate(this.pos.x,this.pos.y),t.scale(1+this.grow*this.alive/this.life,1+this.grow*this.alive/this.life),t.drawImage(e,0,0,this.size.x,this.size.y),t.restore()}},$.ParticleEmitter={particles:[],update:function(t){for(var e=$.ParticleEmitter.particles,i=0;i<e.length;i++)e[i].update(t)&&($.ParticleEmitter.particles.splice(i,1),i--)},draw:function(t){for(var e=$.ParticleEmitter.particles,i=0;i<e.length;i++)e[i].draw(t)},addParticle:function(t,e,i,s){var r=document.createElement("canvas"),n=r.getContext("2d");r.width=5,r.height=5,n.save(),n.fillStyle=$.utils.colorString(s.r,s.g,s.b,s.a),n.fillRect(0,0,5,5),n.restore();var o=new $.Particle(t,r);return o.vel.x=e*Math.sin(i),o.vel.y=e*Math.cos(i),o.dir=i,o.life=2e3,$.ParticleEmitter.particles.push(o),o},add:{fireball:function(t,e,i){var s=document.createElement("canvas"),r=s.getContext("2d");s.width=20,s.height=20;var n=r.createRadialGradient(10,10,2,10,10,7.5);n.addColorStop(0,$.utils.colorString(255,255,0,.8)),n.addColorStop(1,$.utils.colorString(255,0,0,.8)),$.render.fillCircle(r,{x:10,y:10},9,n);var o=new $.Particle(t,s);return o.vel.x=e*Math.sin(i),o.vel.y=e*Math.cos(i),o.dir=i,o.life=2e3,o.size.x=20,o.size.y=20,o.emitter=new $.Emitter,$.ParticleEmitter.particles.push(o),o},explosion:function(t,e,i){var s=document.createElement("canvas"),r=s.getContext("2d");s.width=15,s.height=15;var n=r.createRadialGradient(7.5,7.5,1,7.5,7.5,3);n.addColorStop(0,$.utils.colorString(0,0,0,.8)),n.addColorStop(1,$.utils.colorString(0,0,0,0)),$.render.fillCircle(r,{x:7.5,y:7.5},3,n);var o=new $.Particle(t,s);return o.vel.x=e*Math.sin(i),o.vel.y=e*Math.cos(i),o.dir=i,o.mass=2,o.life=1e3,$.ParticleEmitter.particles.push(o),o},dirt:function(t,e,i){var s=document.createElement("canvas"),r=s.getContext("2d");s.width=15,s.height=15,r.save(),r.fillStyle="rgba(75,50,35,0.6)",r.fillRect(5,5,5,5),r.restore();var n=new $.Particle(t,s);return n.vel.x=e*Math.sin(i),n.vel.y=e*Math.cos(i),n.dir=i,n.mass=2,n.life=1e3,$.ParticleEmitter.particles.push(n),n}}},$.Emitter=function(){},$.Emitter.prototype={update:function(t,e){for(var i=$.utils.deepCopy(e),s=10*Math.random()+10,r=0;s>r;r++){var n=document.createElement("canvas"),o=n.getContext("2d");n.width=6,n.height=6;var a=.7*Math.random()+.3,h=150+100*Math.random(),l=$.utils.colorString(150+100*Math.random(),0,0,a),c=$.utils.colorString(h,h,0,a),d=l;Math.random()>.7&&(d=c),o.save(),o.fillStyle=d,o.fillRect(2,0,2,6),o.restore(),o.save(),o.fillStyle=d,o.fillRect(0,2,6,2),o.restore(),o.save(),o.fillStyle=$.utils.colorString(h,h,0,a),o.fillRect(2,2,2,2),o.restore();var u=new $.Particle({x:i.x+20*Math.random()-10,y:i.y-5*Math.random()+5},n);u.life=1250*Math.random()+250,u.vel.x=100*Math.random()-50,u.vel.y=100*Math.random()-50;var m=3*Math.random()+8;u.size.x=m,u.size.y=m,u.grow=-.25,u.mass=0,$.ParticleEmitter.particles.push(u)}}},$.Shrine=function(t,e,i){this.pos=t,this.radius=55,this.color=e,this.border=i,this.sprite=new $.Sprite;var s=new $.Piece({x:20,y:20}),r=this.color,n=this.border;s.name="head",s.draw=function(t){$.render.fillCircle(t,this.center,20,r),$.render.strokeCircle(t,this.center,20,3,n)};var o=new $.Piece({x:20,y:45});o.name="foot",o.draw=function(t){t.save(),t.fillStyle=$.utils.colorString(r.r,r.g,r.b,r.a),t.beginPath(),t.rect(this.center.x-15,this.center.y,30,10),t.closePath(),t.fill(),t.strokeStyle=$.utils.colorString(n.r,n.g,n.b,n.a),t.lineWidth=3,t.stroke(),t.restore(),t.save(),t.fillStyle=$.utils.colorString(r.r,r.g,r.b,r.a),t.beginPath(),t.rect(this.center.x-25,this.center.y+10,50,20),t.closePath(),t.fill(),t.strokeStyle=$.utils.colorString(n.r,n.g,n.b,n.a),t.lineWidth=3,t.stroke(),t.restore()};var a=new $.Animation;a.skeleton.head=function(t,e,i){e.y=i.y-10-5*Math.sin(this.alive/250)}.bind(a),this.sprite.pieces.push(o),this.sprite.pieces.push(s),this.sprite.animations.idle=a,this.sprite.currentAnimation=this.sprite.animations.idle},$.Shrine.prototype={update:function(t){this.sprite.update(t)},draw:function(t){t.save(),t.translate(this.pos.x,this.pos.y),this.sprite.draw(t),t.restore()}},$.Sprite=function(){this.pieces=[],this.animations={},this.canvas=null,this.ctx=null,this.init()},$.Sprite.prototype={init:function(){},draw:function(t){for(var e=this.pieces,i=0;i<e.length;i++)e[i].draw(t)},update:function(t){this.currentAnimation.update(t);for(var e=this.pieces,i=0;i<e.length;i++)this.currentAnimation.skeleton[e[i].name]&&this.currentAnimation.skeleton[e[i].name](t,e[i].center,e[i].orginalCenter)}},$.Piece=function(t){this.center=t,this.orginalCenter={x:t.x,y:t.y},this.name=""},$.Piece.prototype={draw:function(){}},$.Tile={images:{},init:function(){for(var t=0;t<$.const.COLORS.length;t++){for(var e=[],i=0;4>i;i++){for(var s=$.Tile.generate($.const.COLORS[t],$.const.TILE_SIZE,$.const.TILE_SIZE),r={},n=1;n>=0;n-=.1){var o=$.Tile.applyLighting(s,n,$.const.TILE_SIZE,$.const.TILE_SIZE);1==n&&$.Tile.applyGrass(o.getContext("2d"),$.const.TILE_SIZE,$.const.TILE_SIZE),r[n.toFixed(1)]=o}e.push(r)}$.Tile.images[$.const.COLORS[t].name]=e}console.log($.Tile.images)},applyLighting:function(t,e,i,s){var r=document.createElement("canvas"),n=r.getContext("2d");return r.width=i,r.height=s,n.save(),n.drawImage(t,0,0,i,s),n.save(),n.fillStyle=$.utils.colorString(0,0,0,1-e),n.fillRect(0,0,i,s),n.restore(),n.restore(),r},applyGrass:function(t,e){var i={r:28,g:216,b:94},s=document.createElement("canvas"),r=s.getContext("2d");s.width=5,s.height=5,r.save(),r.fillStyle=$.utils.colorString(i.r,i.g,i.b,1),r.fillRect(0,0,5,2),r.restore(),r.save(),r.fillStyle=$.utils.colorString(i.r,i.g,i.b,1),r.fillRect(3*Math.random()+1,0,1,5),r.restore(),r.save(),r.fillStyle=$.utils.colorString(i.r,i.g,i.b,1),r.fillRect(3*Math.random()+1,0,1,5),r.restore(),t.save(),t.drawImage(s,0,0,e,5),t.restore()},generate:function(t,e,i){var s=document.createElement("canvas"),r=s.getContext("2d");s.width=$.const.TILE_SIZE,s.height=$.const.TILE_SIZE;var n,o,a,h;return r.save(),r.fillStyle=$.utils.colorString(t.r,t.g,t.b,t.a),r.fillRect(0,0,e,i),r.restore(),r.save(),a=4,h=4,n=Math.floor(Math.random()*(e-4))+4,o=Math.floor(Math.random()*(i-4))+4,r.fillStyle=$.utils.colorString(.9*t.r,.9*t.g,.9*t.b,t.a),r.fillRect(n,o,a,h),r.restore(),r.save(),a=4,h=4,n=Math.floor(Math.random()*(e-4))+4,o=Math.floor(Math.random()*(i-4))+4,r.fillStyle=$.utils.colorString(1.2*t.r,1.2*t.g,1.2*t.b,t.a),r.fillRect(n,o,a,h),r.restore(),r.save(),a=4,h=4,n=Math.floor(Math.random()*(e-4))+4,o=Math.floor(Math.random()*(i-4))+4,r.fillStyle=$.utils.colorString(.7*t.r,.7*t.g,.7*t.b,t.a),r.fillRect(n,o,a,h),r.restore(),s},generateWater:function(t,e){var i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t,i.height=e,s.save(),s.fillStyle=$.utils.colorString(0,0,255,.3),s.fillRect(0,0,t,e),s.restore(),i}},$.Tile.Dirt=function(t){this.pos=t,this.image=$.utils.getRandom($.Tile.images.dirt),this.particle=new $.Particle(t,this.image),this.solid=!0},$.Tile.Dirt.prototype={draw:function(t,e){this.particle.draw(t,e)}},$.keybindings={up:{},down:{}},$.pressed={},$.utils={bindKeyDown:function(t,e){$.keybindings.down[t]=e},bindKeyUp:function(t,e){$.keybindings.up[t]=e},requestAnimFrame:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}},distance:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},colorString:function(t,e,i,s){return"rgba("+Math.floor(t)+","+Math.floor(e)+","+Math.floor(i)+","+s+")"},getRandom:function(t){return t[Math.floor(Math.random()*t.length)]},getRandomIndex:function(t){return Math.floor(Math.random()*t.length)},toIndex:function(t,e){return Math.floor(t/e)},toWorldIndex:function(t){return $.utils.toIndex(t,$.const.TILE_SIZE)},deepCopy:function(t){return JSON.parse(JSON.stringify(t))},detectRadiusCollision:function(t,e,i){return $.utils.distance(t,e)<i},detectCollision:function(t,e){{var i={top:!1,right:!1,bottom:!1,left:!1},s=t.x,r=t.x+t.width,n=t.y,o=t.y+t.height,a=t.x+t.width/2,h=t.y+t.height/2,l=e.x,c=e.x+e.width,d=e.y,u=e.y+e.height,m=e.x+e.width/2;e.y+e.height/2}return u>n&&n>d&&t.vel.y<0&&Math.abs(a-m)<e.width/2&&(i.top=!0),o>d&&u>o&&Math.abs(a-m)<e.width/2&&(i.bottom=!0),c>s&&s>l&&$.utils.toIndex(h,e.width)===$.utils.toIndex(d,e.width)?i.left=!0:r>l&&c>r&&$.utils.toIndex(h,e.width)===$.utils.toIndex(d,e.width)&&(i.right=!0),i}},$.render={fillCircle:function(t,e,i,s){var r=s;void 0!==s.r&&void 0!==s.g&&void 0!==s.b&&(r=$.utils.colorString(s.r,s.g,s.b,s.a||1)),t.save(),t.fillStyle=r,t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI,!1),t.closePath(),t.fill(),t.restore()},strokeCircle:function(t,e,i,s,r){t.save(),t.strokeStyle=$.utils.colorString(r.r,r.g,r.b,r.a),t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI,!1),t.closePath(),t.lineWidth=s,t.stroke(),t.restore()}},$.const={NUM_SEEDS:3,TILE_SIZE:15,SIZE:{x:7e3,y:2e3},CAMERA:{x:800,y:400},COLORS:[{name:"dirt",r:153,g:107,b:74,a:1}],KEYS:{38:"up",40:"down",39:"right",37:"left",90:"z",65:"a",87:"w",68:"d",83:"s",32:"space",49:"1",50:"2",51:"3",27:"esc",192:"`"},WIDTH:800,HEIGHT:450,GRAVITY:300,CELL_AUTOMATA:{BIRTH:3,DEATH:4,STARVE:4,OVER:4,ROUGH_STEPS:12,FINE_STEPS:4,CHANCE_START:.4,FLOOR_START:13}},$.World=function(){this.tiles=[],this.map=[],this.caverns=[],this.width=50,this.backdrop=null,this.tileImages=[],this.isNightBool=!1,this.isDayBool=!0,this.generateBackdrop(),this.generateWorld()},$.World.prototype={generateCellMap:function(t,e){var i=Array.apply(null,Array(t)).map(function(){return Array.apply(null,Array(e)).map(function(){return Math.random()<$.const.CELL_AUTOMATA.CHANCE_START?1:0})});return i},generateCaverns:function(t){for(var e=$.const.CELL_AUTOMATA.ROUGH_STEPS;e--;)this.caveSimulationStep(t);this.smoothCaves(t)},smoothCaves:function(t){for(var e=1;e<t.length-1;e++)for(var i=1;i<t[e].length-1;i++){var s=0;t[e-1][i]&&s++,t[e+1][i]&&s++,t[e][i-1]&&s++,t[e][i+1]&&s++,2>s&&(t[e][i]=0)}},caveSimulationStep:function(t){for(var e=$.utils.deepCopy(t),i=0;i<t.length;i++)for(var s=0;s<t[i].length;s++){var r=this.countAliveNeighbors(e,i,s);t[i][s]=e[i][s]?r<$.const.CELL_AUTOMATA.DEATH?0:1:r>$.const.CELL_AUTOMATA.BIRTH?1:0}return t},countAliveNeighbors:function(t,e,i){for(var s=t.length,r=t[0].length,n=0,o=-1;2>o;o++)for(var a=-1;2>a;a++){var h=e+o,l=i+a;0===o&&0===a||(0>h||0>l||h>s-1||l>r-1?n++:t[h][l]&&n++)}return n},generateTopSoil:function(t,e){for(var i=20;i<t.length-20;i++)for(var s=e;e+5>s;s++)t[i][s]=1},fillDirt:function(t){for(var e=t.length;e--;){this.tiles[e]=[];for(var i=t[e].length;i--;)this.tiles[e][i]=null,1===t[e][i]&&(this.tiles[e][i]=new $.Tile.Dirt({x:e*$.const.TILE_SIZE,y:i*$.const.TILE_SIZE}))
}},applyOceans:function(t){for(var e=0;20>e;e++)for(var i=50;i<t[e].length;i++)t[e][i]=1;for(var e=t.length-21;e<t.length;e++)for(var i=50;i<t[e].length;i++)t[e][i]=1},applyCaverns:function(t,e,i){for(var s=20,r=i,n=0;n<e.length;n++)for(var o=0;o<e[n].length;o++)t[n+s][o+r]=e[n][o]},getCaverns:function(t){var e=2;this.caverns[0]=0,this.caverns[1]=0;for(var i=1;i<t.length-1;i++)for(var s=1;s<t.length-1;s++)0===t[i][s]&&(this.caverns[e]=0,this.floodFill(i,s,t,e),e++);for(var i=0;i<t.length;i++)for(var s=0;s<t.length;s++)this.caverns[t[i][s]]=this.caverns[t[i][s]]||{index:t[i][s],count:0},this.caverns[t[i][s]].count++;for(var i=0;i<t.length;i++)for(var s=0;s<t.length;s++)this.caverns[t[i][s]].count<200&&(t[i][s]=1)},floodFill:function(t,e,i,s){t>0&&e>0&&t<i.length&&e<i[0].length&&0===i[t][e]&&(i[t][e]=s,this.floodFill(t-1,e,i,s),this.floodFill(t+1,e,i,s),this.floodFill(t,e-1,i,s),this.floodFill(t,e+1,i,s))},generateWorld:function(){var t=$.utils.toWorldIndex($.const.SIZE.x),e=$.utils.toWorldIndex($.const.SIZE.y),i=$.utils.toWorldIndex(200),s=Array.apply(null,Array(t)).map(function(){return Array.apply(null,Array(e)).map(function(){return 0})}),r=this.generateCellMap(t-40,e-i-5);this.generateCaverns(r),this.applyCaverns(s,r,i+5),this.generateTopSoil(s,i),this.applyOceans(s);var n=Array.apply(null,new Array(t-40)).map(Number.prototype.valueOf,0);this.applyPeaks(n,0,n.length-1,10,3);for(var o=0;o<n.length;o++){var a=Math.min(i,i-n[o]),h=Math.max(i,i-n[o]),l=1;n[o]<0&&(l=0);for(var c=a;h>c;c++)s[o][c]=l}this.getCaverns(s),this.map=s,this.fillDirt(s)},setDay:function(){this.isNightBool=!1,this.isDayBool=!0,this.backdrop=this.day},setNight:function(){this.isNightBool=!0,this.isDayBool=!1},isDay:function(){return this.isDayBool},isNight:function(){return this.isNightBool},findFloor:function(t){for(var e=0;e<this.tiles[t].length;e++)if(null!==this.tiles[t][e]&&this.tiles[t][e].solid)return this.tiles[t][e]},applyPeaks:function(t,e,i,s,r){var n=Math.floor((i-e)/2)+e,o=Math.floor(Math.random()*s-s/2);t[n]=o;for(var a=Math.floor(8*Math.random())+2,h=n-a;n+a>h;h++)t[h]=o;var l=1;0>o&&(l=-1);for(var h=Math.abs(o);h>=0;h--)t[h+n-a]=o-l*(o*l-h);for(var h=0;h<Math.abs(o);h++)t[h+n+a]=o-h*l;r>0&&(this.applyPeaks(t,e,n,s,r-1),this.applyPeaks(t,n+1,i,s,r-1))},generateDay:function(){var t=$.const.WIDTH,e=$.const.HEIGHT,i=document.createElement("canvas"),s=i.getContext("2d");i.width=t,i.height=e,s.save(),s.rect(0,0,t,e);var r=s.createLinearGradient(0,e,0,0);return r.addColorStop(0,"#93C0DD"),r.addColorStop(1,"#309AE0"),s.fillStyle=r,s.fill(),s.restore(),s.save(),s.drawImage(this.generateMountainScape(),0,0,t,e),s.restore(),i},generateNight:function(){var t=$.const.WIDTH,e=$.const.HEIGHT,i=document.createElement("canvas"),s=i.getContext("2d");i.width=t,i.height=e,s.save(),s.rect(0,0,t,e);var r=s.createLinearGradient(0,e,0,0);return r.addColorStop(0,"#112233"),r.addColorStop(1,"#000000"),s.fillStyle=r,s.fill(),s.restore(),i},generateBackdrop:function(){this.day=this.generateDay(),this.night=this.generateNight(),this.backdrop=this.day},generateMountainScape:function(){var t=document.createElement("canvas"),e=t.getContext("2d");return t.width=400,t.height=100,e.save(),e.beginPath(),e.moveTo(0,100),e.lineTo(50*Math.random(),400*Math.random()),e.lineTo(50*Math.random()+50,400*Math.random()),e.lineTo(50*Math.random()+100,400*Math.random()),e.lineTo(50*Math.random()+150,400*Math.random()),e.lineTo(50*Math.random()+200,400*Math.random()),e.lineTo(50*Math.random()+250,400*Math.random()),e.lineTo(50*Math.random()+300,400*Math.random()),e.lineTo(50*Math.random()+350,400*Math.random()),e.lineTo(400,100),e.lineTo(0,100),e.closePath(),e.fillStyle="rgb(100,80,60)",e.fill(),e.restore(),e.save(),e.fillStyle="rgba(240,240,255,0.5)",e.beginPath(),e.arc(5,5,2,0,2*Math.PI,!1),e.closePath(),e.fill(),e.restore(),t},update:function(){},drawBackground:function(t){t.save(),t.drawImage(this.backdrop,0,0),t.restore()},draw:function(t,e){var i=$.utils.toWorldIndex(e.offset.x),s=$.utils.toWorldIndex(e.offset.x+e.viewWidth);i=Math.max(5,i),s=Math.min(s,this.tiles.length-5);var r=$.utils.toWorldIndex(e.offset.y),n=$.utils.toWorldIndex(e.offset.y+e.viewHeight);r=Math.max(5,r),n=Math.min(n,this.tiles[0].length-5);for(var o=i-5;s+5>o;o++)for(var a=this.tiles[o],h=1,l=r-5;n+5>l;l++)null!==a[l]&&a[l].solid?(a[l].draw(t,a[l].image[h.toFixed(1)]),h-=.1,0>h&&(h=0)):h=1}};