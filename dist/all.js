$.Camera=function(){this.offset={x:0,y:-100},this.viewWidth=0,this.gutter=0},$.Camera.prototype={moveLeft:function(){this.move("x",-1)},moveRight:function(){this.move("x",1)},move:function(t,i){this.offset[t]+=i},update:function(t){t.x>this.absoluteRight()?this.offset.x+=t.x-this.absoluteRight():t.x<this.absoluteLeft()&&(this.offset.x-=this.absoluteLeft()-t.x)},absoluteRight:function(){return this.viewWidth-this.gutter+this.offset.x},absoluteLeft:function(){return this.offset.x+this.gutter}},$.Game=function(){this.hero=null,this.running=!1,this.canvas=null,this.context=null,this.init(),this.width=800,this.height=450,this.time={last:0,delta:0,total:0},this.mouse={x:0,y:0}},$.Game.prototype={init:function(){this.initObjects(),this.initCanvas(),this.initKeybindings(),this.initMouse()},initObjects:function(){$.Tile.init(),this.hero=new $.Hero,this.world=new $.World,this.camera=new $.Camera,this.camera.offset.x=1e3,this.hero.pos.x=1500,this.camera.viewWidth=800,this.camera.gutter=100},initCanvas:function(){this.canvas=document.getElementById("world"),this.context=this.canvas.getContext("2d")},initMouse:function(){this.canvas.onmousemove=function(t){this.mouse.x=t.x-this.canvas.offsetLeft-5+this.camera.offset.x,this.mouse.y=t.y-this.canvas.offsetTop-5+this.camera.offset.y}.bind(this),this.canvas.onmousedown=function(){$.pressed.mouse=!0}.bind(this),this.canvas.onmouseup=function(){$.pressed.mouse=!1}.bind(this)},initKeybindings:function(){$.utils.bindKeyDown("a",this.hero.moveLeft.bind(this.hero)),$.utils.bindKeyDown("d",this.hero.moveRight.bind(this.hero)),$.utils.bindKeyDown("space",this.hero.jump.bind(this.hero)),$.utils.bindKeyDown("1",this.hero.setMode.bind(this.hero,1)),$.utils.bindKeyDown("2",this.hero.setMode.bind(this.hero,2)),$.utils.bindKeyDown("3",this.hero.setMode.bind(this.hero,4)),$.utils.bindKeyDown("esc",this.hero.setMode.bind(this.hero,0)),$.utils.bindKeyDown("z",this.hero.power.bind(this.hero,this.world.tiles)),$.utils.bindKeyUp("a",this.hero.stop.bind(this.hero)),$.utils.bindKeyUp("d",this.hero.stop.bind(this.hero)),window.onkeydown=function(t){var i=$.const.KEYS[t.keyCode]||t.keyCode;console.log("[KEY PRESSED] {%s : %s}",t.keyCode,i),$.pressed[i]=!0,$.keybindings.down[i]&&$.keybindings.down[i]()},window.onkeyup=function(t){var i=$.const.KEYS[t.keyCode]||t.keyCode;$.pressed[i]=!1,$.keybindings.up[i]&&$.keybindings.up[i]()}},handleEvents:function(){for(key in $.keybindings)$.pressed[key]&&(console.log("[KEY EVENT] %s",key),$.keybindings[key]())},update:function(t){$.pressed.mouse&&this.hero.power(this.world.tiles,this.mouse),this.hero.update(t),this.world.update(t)},collisions:function(){var t=this.hero.getCenter().x,i=this.hero.getCenter().y,e=6,s=8,o=Math.floor(t/$.const.TILE_SIZE)-3,n=Math.floor(i/$.const.TILE_SIZE)-4;0>o&&(o=0),0>n&&(n=0);for(var h=this.world.tiles,r=o;o+e>r;r++)for(var a=n;n+s>a;a++)null!==h[r][a]&&this.hero.handleCollision(h[r][a].pos,$.const.TILE_SIZE,r,a)},draw:function(){this.context.clearRect(0,0,this.width,this.height),this.context.save(),this.world.drawBackground(this.context,this.width,this.height),this.context.translate(-this.camera.offset.x,-this.camera.offset.y),this.world.draw(this.context,this.camera),this.hero.draw(this.context),0!==this.hero.mode&&this.drawMouse(this.context),this.context.restore()},drawMouse:function(t){var i=Math.floor(this.mouse.x/$.const.TILE_SIZE)*$.const.TILE_SIZE,e=Math.floor(this.mouse.y/$.const.TILE_SIZE)*$.const.TILE_SIZE;t.save(),t.save(),t.strokeStyle=$.utils.colorString(59,188,217,1),t.rect(i,e,$.const.TILE_SIZE,$.const.TILE_SIZE),t.stroke(),t.strokeStyle=$.utils.colorString(18,51,64,1),t.rect(i,e,$.const.TILE_SIZE,$.const.TILE_SIZE),t.stroke(),t.restore(),t.restore()},pause:function(){this.running=!1},run:function(){this.running=!0,this.tick()},start:function(){this.run()},tick:function(t){var i=t||0;0===this.time.last&&(this.time.last=i),this.time.delta=i-this.time.last,this.time.delta>50&&(this.time.delta=50),this.time.total+=this.time.delta,this.update(this.time.delta),this.collisions(),this.camera.update(this.hero.pos),this.time.last=i,this.hero.win()&&alert("You Win!"),this.draw(),this.running&&requestAnimationFrame(this.tick.bind(this))}},$.Hero=function(){this.pos={x:0,y:0},this.vel={x:0,y:0,max:300,delta:{x:0,y:0}},this.acc={x:0,y:0},this.delta={x:0,y:0},this.mass=5,this.prevPos=this.pos,this.dir=1,this.powers=[],this.health=100,this.jumpCounter=0,this.width=$.const.TILE_SIZE,this.height=$.const.TILE_SIZE,this.radius=$.const.TILE_SIZE/2,this.mineDistance=100,this.inventory={dirt:0},this.time=0,this.height=15,this.frame={num:0,cur:0,step:250},this.mode=0,this.shrines=0},$.Hero.prototype={win:function(){return 4===this.shrines},getCenter:function(){return{x:this.pos.x+this.width/2,y:this.pos.y+this.height/2}},setMode:function(t){this.mode=t},power:function(t,i){var e=Math.floor(i.x/$.const.TILE_SIZE),s=Math.floor(i.y/$.const.TILE_SIZE);1&this.mode&&null!==t[e][s]&&this.withinRange(i)?(t[e][s]=null,this.inventory.dirt++):this.mode>>1&1&&this.inventory.dirt>0&&this.withinRange(i)?null===t[e][s]&&(t[e][s]=new $.Tile.Dirt({x:e*$.const.TILE_SIZE,y:s*$.const.TILE_SIZE}),this.inventory.dirt--):this.mode>>2&1&&console.log("FIRE",this.mode)},withinRange:function(t){return Math.abs($.utils.distance(t,this.pos))<this.mineDistance},moveLeft:function(){this.dir=-1,this.acc.x=650},moveRight:function(){this.dir=1,this.acc.x=650},stop:function(){this.acc.x=-1e3},move:function(t,i){this.pos[t]+=i},handleCollision:function(t,i){{var e=this.pos.x,s=this.pos.x+this.width,o=this.pos.y,n=this.pos.y+this.height,h=this.pos.x+this.width/2,r=(this.pos.y+this.height/2,t.x),a=t.x+i,l=t.y,c=t.y+i,d=t.x+i/2;t.y+i/2}return c>o&&o>l&&Math.abs(h-d)<i/2?(this.pos.y=c,this.acc.y=0,this.vel.y=0,!0):n>l&&c>n&&Math.abs(h-d)<i/2?(this.pos.y=l-this.height,this.acc.y=0,this.vel.y=0,this.jumpCounter=0,!0):(a>e&&e>r&&$.utils.toIndex(o,i)===$.utils.toIndex(l,i)?(this.pos.x=a,this.vel.x=0):s>r&&a>s&&$.utils.toIndex(o,i)===$.utils.toIndex(l,i)&&(this.pos.x=r-this.width,this.vel.x=0),!1)},jump:function(){this.jumpCounter<2&&(console.log("jump"),this.jumpCounter++,this.vel.y=-500)},update:function(t){var i=t/1e3;this.vel.delta.x=this.dir*i*this.acc.x,Math.abs(this.vel.x+this.vel.delta.x)<=this.vel.max&&(this.vel.x+=this.vel.delta.x),(this.vel.x<0&&1===this.dir||this.vel.x>0&&-1===this.dir)&&(this.vel.x=0),this.vel.y+=i*this.acc.y+i*$.const.GRAVITY*this.mass,this.delta.x=this.vel.x*i,this.delta.y=this.vel.y*i,this.prevPos={x:this.pos.x,y:this.pos.y},this.pos.x+=this.delta.x,this.pos.y+=this.delta.y,this.time+=t},draw:function(t){var i=this.pos.x,e=this.pos.y,s=7.5;t.save();var o={x:i+5,y:e-this.height/3*1},n={x:i+5,y:e-this.height/3*2},h=Math.sin(this.time/150),r=Math.cos(this.time/150);console.log(.1*this.vel.x);var a=h*this.width/4+i+5+-1*this.vel.x*.05,l=5*r+e-this.height;t.beginPath(),t.moveTo(i,this.getCenter().y),t.bezierCurveTo(o.x,o.y,n.x+r*(this.width/2),n.y,a,l),t.bezierCurveTo(n.x+r*(this.width/2),n.y,o.x,o.y+10*r,i+this.width,this.getCenter().y),t.strokeStyle="#400900",t.stroke(),t.closePath(),t.fillStyle="rgba(255,3,0,0.6)",t.fill(),t.restore(),t.save(),t.fillStyle="rgba(18,51,64, 0.95)",t.beginPath(),t.arc(i+s,e+s,s,0,2*Math.PI,!1),t.closePath(),t.fill(),t.restore()}};var elements=new $.Game;elements.start(),$.Particle=function(t,i){this.pos=t||{x:0,y:0},this.image=i,this.velocity=0,this.direction=0,this.life=0,this.alive=0},$.Particle.prototype={update:function(t){return this.alive+=t,this.life<this.alive?!1:!0},draw:function(t,i){i=i||this.image,t.save(),t.translate(this.pos.x,this.pos.y),t.drawImage(i,0,0,$.const.TILE_SIZE,$.const.TILE_SIZE),t.restore()}},$.Tile={images:{},init:function(){for(var t=0;t<$.const.COLORS.length;t++){for(var i=[],e=0;4>e;e++){for(var s=$.Tile.generate($.const.COLORS[t],$.const.TILE_SIZE,$.const.TILE_SIZE),o={},n=1;n>=0;n-=.1){var h=$.Tile.applyLighting(s,n,$.const.TILE_SIZE,$.const.TILE_SIZE);1==n&&$.Tile.applyGrass(h.getContext("2d"),$.const.TILE_SIZE,$.const.TILE_SIZE),o[n.toFixed(1)]=h}i.push(o)}$.Tile.images[$.const.COLORS[t].name]=i}console.log($.Tile.images)},applyLighting:function(t,i,e,s){var o=document.createElement("canvas"),n=o.getContext("2d");return o.width=e,o.height=s,n.save(),n.drawImage(t,0,0,e,s),n.save(),n.fillStyle=$.utils.colorString(0,0,0,1-i),n.fillRect(0,0,e,s),n.restore(),n.restore(),o},applyGrass:function(t,i){var e={r:28,g:216,b:94},s=document.createElement("canvas"),o=s.getContext("2d");s.width=5,s.height=5,o.save(),o.fillStyle=$.utils.colorString(e.r,e.g,e.b,1),o.fillRect(0,0,5,2),o.restore(),o.save(),o.fillStyle=$.utils.colorString(e.r,e.g,e.b,1),o.fillRect(3*Math.random()+1,0,1,5),o.restore(),o.save(),o.fillStyle=$.utils.colorString(e.r,e.g,e.b,1),o.fillRect(3*Math.random()+1,0,1,5),o.restore(),t.save(),t.drawImage(s,0,0,i,5),t.restore()},generate:function(t,i,e){var s=document.createElement("canvas"),o=s.getContext("2d");s.width=$.const.TILE_SIZE,s.height=$.const.TILE_SIZE;var n,h,r,a;return o.save(),o.fillStyle=$.utils.colorString(t.r,t.g,t.b,t.a),o.fillRect(0,0,i,e),o.restore(),o.save(),r=4,a=4,n=Math.floor(Math.random()*(i-4))+4,h=Math.floor(Math.random()*(e-4))+4,o.fillStyle=$.utils.colorString(.9*t.r,.9*t.g,.9*t.b,t.a),o.fillRect(n,h,r,a),o.restore(),o.save(),r=4,a=4,n=Math.floor(Math.random()*(i-4))+4,h=Math.floor(Math.random()*(e-4))+4,o.fillStyle=$.utils.colorString(1.2*t.r,1.2*t.g,1.2*t.b,t.a),o.fillRect(n,h,r,a),o.restore(),o.save(),r=4,a=4,n=Math.floor(Math.random()*(i-4))+4,h=Math.floor(Math.random()*(e-4))+4,o.fillStyle=$.utils.colorString(.7*t.r,.7*t.g,.7*t.b,t.a),o.fillRect(n,h,r,a),o.restore(),s}},$.Tile.Dirt=function(t){this.pos=t,this.image=$.utils.getRandom($.Tile.images.dirt),this.particle=new $.Particle(t,this.image)},$.Tile.Dirt.prototype={draw:function(t,i){this.particle.draw(t,i)}},$.keybindings={up:{},down:{}},$.pressed={},$.utils={bindKeyDown:function(t,i){$.keybindings.down[t]=i},bindKeyUp:function(t,i){$.keybindings.up[t]=i},requestAnimFrame:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}},distance:function(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))},colorString:function(t,i,e,s){return"rgba("+Math.floor(t)+","+Math.floor(i)+","+Math.floor(e)+","+s+")"},getRandom:function(t){return t[Math.floor(Math.random()*t.length)]},toIndex:function(t,i){return Math.floor(t/i)}},$.const={NUM_SEEDS:3,TILE_SIZE:15,SIZE:{x:6e3,y:900},COLORS:[{name:"dirt",r:153,g:107,b:74,a:1}],KEYS:{38:"up",40:"down",39:"right",37:"left",90:"z",65:"a",87:"w",68:"d",83:"s",32:"space",49:"1",50:"2",51:"3",27:"esc"},WIDTH:800,HEIGHT:450,GRAVITY:300},$.World=function(){this.tiles=[],this.width=50,this.backdrop=null,this.tileImages=[],this.generateBackdrop(),this.generateWorld()},$.World.prototype={generateWorld:function(){var t=Math.floor($.const.SIZE.x/$.const.TILE_SIZE),i=Math.floor($.const.SIZE.y/$.const.TILE_SIZE),e=Math.floor(200/$.const.TILE_SIZE),s=Array.apply(null,new Array(t)).map(Number.prototype.valueOf,0);this.applyPeaks(s,0,s.length-1,10,3);for(var o=0;t>o;o++){for(var n=[],h=0;i>h;h++){var r=Math.floor(100*Math.random())<1,a=!1;o>0&&(a=Math.floor(10*Math.random())<3&&null!==this.tiles[o-1][h]),r=!1,a=!1;var l=e-s[o];if(l>h&&!r&&!a)n.push(null);else{var c=new $.Tile.Dirt({x:o*$.const.TILE_SIZE,y:h*$.const.TILE_SIZE});n.push(c)}}this.tiles[o]=n}},applyPeaks:function(t,i,e,s,o){var n=Math.floor((e-i)/2)+i,h=Math.floor(Math.random()*s-s/2);t[n]=h;for(var r=Math.floor(8*Math.random())+2,a=n-r;n+r>a;a++)t[a]=h;var l=1;0>h&&(l=-1);for(var a=Math.abs(h);a>=0;a--)t[a+n-r]=h-l*(h*l-a);for(var a=0;a<Math.abs(h);a++)t[a+n+r]=h-a*l;o>0&&(this.applyPeaks(t,i,n,s,o-1),this.applyPeaks(t,n+1,e,s,o-1))},generateBackdrop:function(){var t=$.const.WIDTH,i=$.const.HEIGHT,e=document.createElement("canvas"),s=e.getContext("2d");e.width=t,e.height=i,s.save(),s.rect(0,0,t,i);var o=s.createLinearGradient(0,i,0,0);o.addColorStop(0,"#93C0DD"),o.addColorStop(1,"#309AE0"),s.fillStyle=o,s.fill(),s.restore(),this.backdrop=e},update:function(){},drawBackground:function(t){t.save(),t.drawImage(this.backdrop,0,0),t.restore()},draw:function(t,i){for(var e=Math.floor(i.offset.x/$.const.TILE_SIZE),s=Math.floor((i.offset.x+i.viewWidth)/$.const.TILE_SIZE),o=e-5;s+5>o;o++)for(var n=this.tiles[o],h=1,r=0;r<n.length;r++)null!==n[r]?(n[r].draw(t,n[r].image[h.toFixed(1)]),h-=.1,0>h&&(h=0)):h=1}};