$.Animation=function(){this.life=0,this.alive=0,this.skeleton={}},$.Animation.prototype={update:function(t){this.alive+=t}},$.Camera=function(){this.offset={x:0,y:-100},this.viewWidth=0,this.gutter=0},$.Camera.prototype={moveLeft:function(){this.move("x",-1)},moveRight:function(){this.move("x",1)},move:function(t,i){this.offset[t]+=i},update:function(t){t.x>this.absoluteRight()?this.offset.x+=t.x-this.absoluteRight():t.x<this.absoluteLeft()&&(this.offset.x-=this.absoluteLeft()-t.x)},absoluteRight:function(){return this.viewWidth-this.gutter+this.offset.x},absoluteLeft:function(){return this.offset.x+this.gutter}},$.Game=function(){this.hero=null,this.running=!1,this.canvas=null,this.context=null,this.particles=null,this.width=800,this.height=450,this.time={last:0,delta:0,total:0},this.mouse={x:0,y:0},this.shrines={water:null,earth:null,fire:null,air:null},this.init()},$.Game.prototype={init:function(){this.initObjects(),this.initCanvas(),this.initKeybindings(),this.initMouse(),this.initParticleEmitter(),this.initShrines()},initObjects:function(){$.Tile.init(),this.hero=new $.Hero,this.world=new $.World,this.camera=new $.Camera,this.camera.offset.x=1e3,this.hero.pos.x=1500,this.hero.pos.y=100,this.camera.viewWidth=800,this.camera.gutter=150},initCanvas:function(){this.canvas=document.getElementById("world"),this.context=this.canvas.getContext("2d")},initParticleEmitter:function(){this.particles=$.ParticleEmitter},initShrines:function(){for(var t=$.utils.getRandom(this.world.tiles),i=0;i<t.length;i++)if(t[i]&&t[i].solid){var e=50;this.shrines.water=new $.Shrine({x:t[i].pos.x,y:t[i].pos.y-e},{r:56,g:89,b:200,a:.8}),this.shrines.water.radius=e;break}},initMouse:function(){this.canvas.onmousemove=function(t){var i=this.canvas.getBoundingClientRect();this.mouse.x=t.clientX-i.left-5+this.camera.offset.x,this.mouse.y=t.clientY-i.top-5+this.camera.offset.y}.bind(this),this.canvas.onmousedown=function(){$.pressed.mouse=!0}.bind(this),this.canvas.onmouseup=function(){$.pressed.mouse=!1}.bind(this)},initKeybindings:function(){$.utils.bindKeyDown("a",this.hero.moveLeft.bind(this.hero)),$.utils.bindKeyDown("d",this.hero.moveRight.bind(this.hero)),$.utils.bindKeyDown("space",this.hero.jump.bind(this.hero)),$.utils.bindKeyDown("1",this.hero.setMode.bind(this.hero,1)),$.utils.bindKeyDown("2",this.hero.setMode.bind(this.hero,2)),$.utils.bindKeyDown("3",this.hero.setMode.bind(this.hero,4)),$.utils.bindKeyDown("esc",this.hero.setMode.bind(this.hero,0)),$.utils.bindKeyDown("z",this.hero.power.bind(this.hero,this.world.tiles)),$.utils.bindKeyUp("a",this.hero.stop.bind(this.hero)),$.utils.bindKeyUp("d",this.hero.stop.bind(this.hero)),window.onkeydown=function(t){var i=$.const.KEYS[t.keyCode]||t.keyCode;$.pressed[i]=!0,$.keybindings.down[i]&&$.keybindings.down[i]()},window.onkeyup=function(t){var i=$.const.KEYS[t.keyCode]||t.keyCode;$.pressed[i]=!1,$.keybindings.up[i]&&$.keybindings.up[i]()}},handleEvents:function(){for(key in $.keybindings)$.pressed[key]&&$.keybindings[key]()},update:function(t){$.pressed.mouse&&this.hero.power(this.world.tiles,this.mouse),this.hero.update(t),this.world.update(t),this.particles.update(t)},collisions:function(){var t=this.hero.getCenter().x,i=this.hero.getCenter().y,e=6,s=8,n=Math.floor(t/$.const.TILE_SIZE)-3,o=Math.floor(i/$.const.TILE_SIZE)-4;n=Math.max(0,n),o=Math.max(0,o);for(var r=this.world.tiles,h=n;n+e>h;h++)for(var a=o;o+s>a;a++)if(r[h][a]&&r[h][a].solid){this.hero.handleCollision(r[h][a].pos,$.const.TILE_SIZE,h,a)}this.shrines.water&&$.utils.distance(this.shrines.water.pos,this.hero.pos)<this.shrines.water.radius+this.hero.height&&(this.hero.shrines++,$.ParticleEmitter.addParticle(this.shrines.water.pos,200,Math.PI,{r:255,g:255,b:255,a:.5}),this.shrines.water=null)},draw:function(){this.context.clearRect(0,0,this.width,this.height),this.context.save(),this.world.drawBackground(this.context,this.width,this.height),this.context.translate(-this.camera.offset.x,-this.camera.offset.y),this.world.draw(this.context,this.camera),this.hero.draw(this.context),this.particles.draw(this.context),this.shrines.water&&this.shrines.water.draw(this.context),0!==this.hero.mode&&this.drawMouse(this.context),this.context.restore()},drawMouse:function(t){var i=Math.floor(this.mouse.x/$.const.TILE_SIZE)*$.const.TILE_SIZE,e=Math.floor(this.mouse.y/$.const.TILE_SIZE)*$.const.TILE_SIZE;t.save(),t.save(),t.strokeStyle=$.utils.colorString(59,188,217,1),t.rect(i,e,$.const.TILE_SIZE,$.const.TILE_SIZE),t.stroke(),t.strokeStyle=$.utils.colorString(18,51,64,1),t.rect(i,e,$.const.TILE_SIZE,$.const.TILE_SIZE),t.stroke(),t.restore(),t.restore()},pause:function(){this.running=!1},run:function(){this.running=!0,this.tick()},start:function(){this.run()},tick:function(t){var i=t||0;0===this.time.last&&(this.time.last=i),this.time.delta=i-this.time.last,this.time.delta>50&&(this.time.delta=50),this.time.total+=this.time.delta,this.update(this.time.delta),this.collisions(),this.camera.update(this.hero.pos),this.time.last=i,this.hero.win()&&console.log("You Win!!!!"),this.draw(),this.running&&requestAnimationFrame(this.tick.bind(this))}},$.Hero=function(){this.pos={x:0,y:0},this.vel={x:0,y:0,max:300,delta:{x:0,y:0}},this.acc={x:0,y:0},this.delta={x:0,y:0},this.mass=5,this.prevPos=this.pos,this.dir=1,this.powers=[],this.health=100,this.jumpCounter=0,this.width=$.const.TILE_SIZE,this.height=$.const.TILE_SIZE,this.radius=$.const.TILE_SIZE/2,this.mineDistance=100,this.inventory={dirt:0},this.time=0,this.height=22.5,this.frame={num:0,cur:0,step:250},this.mode=0,this.shrines=0,this.sprite=new $.Sprite;var t=new $.Piece({x:7.5,y:7.5});t.name="head",t.draw=function(t){$.render.fillCircle(t,this.center,7.5,{r:42,g:239,b:247,a:.8}),$.render.strokeCircle(t,this.center,7.5,3,{r:11,g:73,b:182,a:.5})};var i=new $.Piece({x:7.5,y:17.5});i.name="foot",i.draw=function(t){$.render.fillCircle(t,this.center,3.75,{r:42,g:239,b:247,a:.8}),$.render.strokeCircle(t,this.center,3.75,3,{r:11,g:73,b:182,a:.5})};var e=new $.Animation;e.skeleton.head=function(t,i,e){i.y=e.y-3-1*Math.sin(this.alive/250)}.bind(e),this.sprite.pieces.push(i),this.sprite.pieces.push(t),this.sprite.animations.idle=e,this.sprite.currentAnimation=this.sprite.animations.idle},$.Hero.prototype={win:function(){return 1===this.shrines},getCenter:function(){return{x:this.pos.x+this.width/2,y:this.pos.y+this.height/2}},setMode:function(t){this.mode=t},power:function(t,i){var e=Math.floor(i.x/$.const.TILE_SIZE),s=Math.floor(i.y/$.const.TILE_SIZE);1&this.mode&&null!==t[e][s]&&this.withinRange(i)?(t[e][s]=null,this.inventory.dirt++,$.ParticleEmitter.addParticle({x:i.x,y:i.y},200,Math.PI,{r:255,g:255,b:255,a:.5})):this.mode>>1&1&&this.inventory.dirt>0&&this.withinRange(i)?null===t[e][s]&&(t[e][s]=new $.Tile.Dirt({x:e*$.const.TILE_SIZE,y:s*$.const.TILE_SIZE}),this.inventory.dirt--):this.mode>>2&1&&console.log("FIRE",this.mode),document.getElementById("dirt-num").innerHTML=this.inventory.dirt},withinRange:function(t){return Math.abs($.utils.distance(t,this.pos))<this.mineDistance},moveLeft:function(){this.dir=-1,this.acc.x=650},moveRight:function(){this.dir=1,this.acc.x=650},stop:function(){this.acc.x=-1e3},move:function(t,i){this.pos[t]+=i},handleCollision:function(t,i){{var e=this.pos.x,s=this.pos.x+this.width,n=this.pos.y,o=this.pos.y+this.height,r=this.pos.x+this.width/2,h=(this.pos.y+this.height/2,t.x),a=t.x+i,l=t.y,c=t.y+i,d=t.x+i/2;t.y+i/2}return c>n&&n>l&&this.vel.y<0&&Math.abs(r-d)<i/2?(this.pos.y=c,this.acc.y=0,this.vel.y=0,!0):o>l&&c>o&&Math.abs(r-d)<i/2?(this.pos.y=l-this.height,this.acc.y=0,this.vel.y=0,this.jumpCounter=0,!0):(a>e&&e>h&&$.utils.toIndex(n,i)===$.utils.toIndex(l,i)?(this.pos.x=a,this.vel.x=0):s>h&&a>s&&$.utils.toIndex(n,i)===$.utils.toIndex(l,i)&&(this.pos.x=h-this.width,this.vel.x=0),!1)},jump:function(){this.jumpCounter<2&&(this.jumpCounter++,this.vel.y=-500)},update:function(t){var i=t/1e3;this.vel.delta.x=this.dir*i*this.acc.x,Math.abs(this.vel.x+this.vel.delta.x)<=this.vel.max&&(this.vel.x+=this.vel.delta.x),(this.vel.x<0&&1===this.dir||this.vel.x>0&&-1===this.dir)&&(this.vel.x=0),this.vel.y+=i*this.acc.y+i*$.const.GRAVITY*this.mass,this.delta.x=this.vel.x*i,this.delta.y=this.vel.y*i,this.prevPos={x:this.pos.x,y:this.pos.y},this.pos.x+=this.delta.x,this.pos.y+=this.delta.y,this.sprite.update(t),this.time+=t},draw:function(t){var i=this.pos.x,e=this.pos.y;t.save();var s={x:i+5+this.vel.x/70,y:e-this.height/3*1-10},n={x:i+5+this.vel.x/70,y:e-this.height/3*2-10},o=Math.sin(this.time/150),r=Math.cos(this.time/150),h=o*this.width/4+i+5+-1*this.vel.x*.05,a=5*r+e-this.height-10;t.beginPath(),t.moveTo(i+this.vel.x/70,this.getCenter().y-10),t.bezierCurveTo(s.x,s.y,n.x+r*(this.width/2),n.y,h,a),t.bezierCurveTo(n.x+r*(this.width/2),n.y,s.x,s.y+10*r,i+this.width+this.vel.x/70,this.getCenter().y-10),t.strokeStyle="#400900",t.stroke(),t.closePath(),t.fillStyle="rgba(255,3,0,0.6)",t.fill(),t.restore(),t.save(),t.translate(this.pos.x,this.pos.y),this.sprite.draw(t),t.restore()}};var start=document.getElementById("start");start.onclick=function(){var t=new $.Game;t.start(),document.getElementById("pause-pane").style.display="none"},$.Particle=function(t,i){this.pos=t||{x:0,y:0},this.image=i,this.vel=0,this.dir=0,this.life=0,this.alive=0,this.solid=!1},$.Particle.prototype={update:function(t){var i=t/1e3;return this.pos.x+=i*this.vel*Math.sin(this.dir),this.pos.y+=i*this.vel*Math.cos(this.dir),this.alive+=t,this.alive+=t,this.alive>this.life?!0:!1},draw:function(t,i){i=i||this.image,t.save(),t.translate(this.pos.x,this.pos.y),t.drawImage(i,0,0,$.const.TILE_SIZE,$.const.TILE_SIZE),t.restore()}},$.ParticleEmitter={particles:[],update:function(t){for(var i=$.ParticleEmitter.particles,e=0;e<i.length;e++)i[e].update(t)&&($.ParticleEmitter.particles.splice(e,1),e--)},draw:function(t){for(var i=$.ParticleEmitter.particles,e=0;e<i.length;e++)i[e].draw(t)},addParticle:function(t,i,e,s){var n=document.createElement("canvas"),o=n.getContext("2d");n.width=5,n.height=5,o.save(),o.fillStyle=$.utils.colorString(s.r,s.g,s.b,s.a),o.fillRect(0,0,5,5),o.restore();var r=new $.Particle(t,n);r.vel=i,r.dir=e,r.life=2e3,$.ParticleEmitter.particles.push(r)}},$.Shrine=function(t,i){this.pos=t,this.radius=15,this.color=i,console.log(t)},$.Shrine.prototype={draw:function(t){$.render.fillCircle(t,this.pos,this.radius,this.color)}},$.Sprite=function(){this.pieces=[],this.animations={},this.canvas=null,this.ctx=null,this.init()},$.Sprite.prototype={init:function(){},draw:function(t){for(var i=this.pieces,e=0;e<i.length;e++)i[e].draw(t)},update:function(t){this.currentAnimation.update(t);for(var i=this.pieces,e=0;e<i.length;e++)this.currentAnimation.skeleton[i[e].name]&&this.currentAnimation.skeleton[i[e].name](t,i[e].center,i[e].orginalCenter)}},$.Piece=function(t){this.center=t,this.orginalCenter={x:t.x,y:t.y},this.name=""},$.Piece.prototype={draw:function(){}},$.Tile={images:{},init:function(){for(var t=0;t<$.const.COLORS.length;t++){for(var i=[],e=0;4>e;e++){for(var s=$.Tile.generate($.const.COLORS[t],$.const.TILE_SIZE,$.const.TILE_SIZE),n={},o=1;o>=0;o-=.1){var r=$.Tile.applyLighting(s,o,$.const.TILE_SIZE,$.const.TILE_SIZE);1==o&&$.Tile.applyGrass(r.getContext("2d"),$.const.TILE_SIZE,$.const.TILE_SIZE),n[o.toFixed(1)]=r}i.push(n)}$.Tile.images[$.const.COLORS[t].name]=i}console.log($.Tile.images)},applyLighting:function(t,i,e,s){var n=document.createElement("canvas"),o=n.getContext("2d");return n.width=e,n.height=s,o.save(),o.drawImage(t,0,0,e,s),o.save(),o.fillStyle=$.utils.colorString(0,0,0,1-i),o.fillRect(0,0,e,s),o.restore(),o.restore(),n},applyGrass:function(t,i){var e={r:28,g:216,b:94},s=document.createElement("canvas"),n=s.getContext("2d");s.width=5,s.height=5,n.save(),n.fillStyle=$.utils.colorString(e.r,e.g,e.b,1),n.fillRect(0,0,5,2),n.restore(),n.save(),n.fillStyle=$.utils.colorString(e.r,e.g,e.b,1),n.fillRect(3*Math.random()+1,0,1,5),n.restore(),n.save(),n.fillStyle=$.utils.colorString(e.r,e.g,e.b,1),n.fillRect(3*Math.random()+1,0,1,5),n.restore(),t.save(),t.drawImage(s,0,0,i,5),t.restore()},generate:function(t,i,e){var s=document.createElement("canvas"),n=s.getContext("2d");s.width=$.const.TILE_SIZE,s.height=$.const.TILE_SIZE;var o,r,h,a;return n.save(),n.fillStyle=$.utils.colorString(t.r,t.g,t.b,t.a),n.fillRect(0,0,i,e),n.restore(),n.save(),h=4,a=4,o=Math.floor(Math.random()*(i-4))+4,r=Math.floor(Math.random()*(e-4))+4,n.fillStyle=$.utils.colorString(.9*t.r,.9*t.g,.9*t.b,t.a),n.fillRect(o,r,h,a),n.restore(),n.save(),h=4,a=4,o=Math.floor(Math.random()*(i-4))+4,r=Math.floor(Math.random()*(e-4))+4,n.fillStyle=$.utils.colorString(1.2*t.r,1.2*t.g,1.2*t.b,t.a),n.fillRect(o,r,h,a),n.restore(),n.save(),h=4,a=4,o=Math.floor(Math.random()*(i-4))+4,r=Math.floor(Math.random()*(e-4))+4,n.fillStyle=$.utils.colorString(.7*t.r,.7*t.g,.7*t.b,t.a),n.fillRect(o,r,h,a),n.restore(),s},generateWater:function(t,i){var e=document.createElement("canvas"),s=e.getContext("2d");return e.width=t,e.height=i,s.save(),s.fillStyle=$.utils.colorString(0,0,255,.3),s.fillRect(0,0,t,i),s.restore(),e}},$.Tile.Dirt=function(t){this.pos=t,this.image=$.utils.getRandom($.Tile.images.dirt),this.particle=new $.Particle(t,this.image),this.solid=!0},$.Tile.Dirt.prototype={draw:function(t,i){this.particle.draw(t,i)}},$.keybindings={up:{},down:{}},$.pressed={},$.utils={bindKeyDown:function(t,i){$.keybindings.down[t]=i},bindKeyUp:function(t,i){$.keybindings.up[t]=i},requestAnimFrame:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}},distance:function(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))},colorString:function(t,i,e,s){return"rgba("+Math.floor(t)+","+Math.floor(i)+","+Math.floor(e)+","+s+")"},getRandom:function(t){return t[Math.floor(Math.random()*t.length)]},toIndex:function(t,i){return Math.floor(t/i)}},$.render={fillCircle:function(t,i,e,s){t.save(),t.fillStyle=$.utils.colorString(s.r,s.g,s.b,s.a),t.beginPath(),t.arc(i.x,i.y,e,0,2*Math.PI,!1),t.closePath(),t.fill(),t.restore()},strokeCircle:function(t,i,e,s,n){t.save(),t.strokeStyle=$.utils.colorString(n.r,n.g,n.b,n.a),t.beginPath(),t.arc(i.x,i.y,e,0,2*Math.PI,!1),t.closePath(),t.lineWidth=s,t.stroke(),t.restore()}},$.const={NUM_SEEDS:3,TILE_SIZE:15,SIZE:{x:6e3,y:900},COLORS:[{name:"dirt",r:153,g:107,b:74,a:1}],KEYS:{38:"up",40:"down",39:"right",37:"left",90:"z",65:"a",87:"w",68:"d",83:"s",32:"space",49:"1",50:"2",51:"3",27:"esc"},WIDTH:800,HEIGHT:450,GRAVITY:300},$.World=function(){this.tiles=[],this.width=50,this.backdrop=null,this.tileImages=[],this.generateBackdrop(),this.generateWorld()},$.World.prototype={generateWorld:function(){var t=Math.floor($.const.SIZE.x/$.const.TILE_SIZE),i=Math.floor($.const.SIZE.y/$.const.TILE_SIZE),e=Math.floor(200/$.const.TILE_SIZE),s=Array.apply(null,new Array(t)).map(Number.prototype.valueOf,0);this.applyPeaks(s,0,s.length-1,10,3);for(var n=0;t>n;n++){for(var o=[],r=0;i>r;r++){var h=Math.floor(100*Math.random())<1,a=!1;n>0&&(a=Math.floor(10*Math.random())<3&&null!==this.tiles[n-1][r]),h=!1,a=!1;var l=e-s[n];if(l>r&&!h&&!a)o.push(null);else{var c=new $.Tile.Dirt({x:n*$.const.TILE_SIZE,y:r*$.const.TILE_SIZE});o.push(c)}}this.tiles[n]=o}},applyPeaks:function(t,i,e,s,n){var o=Math.floor((e-i)/2)+i,r=Math.floor(Math.random()*s-s/2);t[o]=r;for(var h=Math.floor(8*Math.random())+2,a=o-h;o+h>a;a++)t[a]=r;var l=1;0>r&&(l=-1);for(var a=Math.abs(r);a>=0;a--)t[a+o-h]=r-l*(r*l-a);for(var a=0;a<Math.abs(r);a++)t[a+o+h]=r-a*l;n>0&&(this.applyPeaks(t,i,o,s,n-1),this.applyPeaks(t,o+1,e,s,n-1))},generateBackdrop:function(){var t=$.const.WIDTH,i=$.const.HEIGHT,e=document.createElement("canvas"),s=e.getContext("2d");e.width=t,e.height=i,s.save(),s.rect(0,0,t,i);var n=s.createLinearGradient(0,i,0,0);n.addColorStop(0,"#93C0DD"),n.addColorStop(1,"#309AE0"),s.fillStyle=n,s.fill(),s.restore(),s.save(),s.drawImage(this.generateMountainScape(),0,0,t,i),s.restore(),this.backdrop=e},generateMountainScape:function(){var t=document.createElement("canvas"),i=t.getContext("2d");return t.width=100,t.height=25,i.save(),i.beginPath(),i.moveTo(0,25),i.lineTo(15,15),i.lineTo(25,10),i.lineTo(35,5),i.lineTo(55,15),i.lineTo(75,10),i.lineTo(100,8),i.lineTo(100,25),i.lineTo(0,25),i.closePath(),i.fillStyle="rgb(100,80,60)",i.fill(),i.restore(),i.save(),i.fillStyle="rgba(240,240,255,0.5)",i.beginPath(),i.arc(5,5,2,0,2*Math.PI,!1),i.closePath(),i.fill(),i.restore(),t},update:function(){},drawBackground:function(t){t.save(),t.drawImage(this.backdrop,0,0),t.restore()},draw:function(t,i){var e=Math.floor(i.offset.x/$.const.TILE_SIZE),s=Math.floor((i.offset.x+i.viewWidth)/$.const.TILE_SIZE);e=Math.max(5,e),s=Math.min(s,s+6);for(var n=e-5;s+5>n;n++)for(var o=this.tiles[n],r=1,h=0;h<o.length;h++)null!==o[h]&&o[h].solid?(o[h].draw(t,o[h].image[r.toFixed(1)]),r-=.1,0>r&&(r=0)):r=1}};